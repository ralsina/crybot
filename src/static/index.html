<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Crybot</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#376388">
  <link rel="apple-touch-icon" href="/img/icon-192.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/img/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/img/icon-512.png">
  <link rel="stylesheet" href="/css/app.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- CodeMirror for code editing -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/monokai.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/yaml/yaml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <a href="https://crybot.ralsina.me" class="sidebar-logo" target="_blank" rel="noopener noreferrer">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e3e3e3">
            <path d="M160-120v-200q0-33 23.5-56.5T240-400h480q33 0 56.5 23.5T800-320v200H160Zm200-320q-83 0-141.5-58.5T160-640q0-83 58.5-141.5T360-840h240q83 0 141.5 58.5T800-640q0 83-58.5 141.5T600-440H360ZM240-200h480v-120H240v120Zm120-320h240q50 0 85-35t35-85q0-50-35-85t-85-35H360q-50 0-85 35t-35 85q0 50 35 85t85 35Zm0-80q17 0 28.5-11.5T400-640q0-17-11.5-28.5T360-680q-17 0-28.5 11.5T320-640q0 17 11.5 28.5T360-600Zm240 0q17 0 28.5-11.5T640-640q0-17-11.5-28.5T600-680q-17 0-28.5 11.5T560-640q0 17 11.5 28.5T600-600ZM480-200Zm0-440Z"/>
          </svg>
          <span>Crybot</span>
        </a>
      </div>
      <div class="separator"></div>
      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" data-section="chat">Chat</a>
        <a href="#" class="nav-item" data-section="skills">Skills</a>
        <a href="#" class="nav-item" data-section="scheduled-tasks">Scheduled Tasks</a>
        <a href="#" class="nav-item" data-section="mcp">MCP</a>
        <a href="#" class="nav-item" data-section="configuration">Configuration</a>
        <a href="#" class="nav-item" data-section="logs">Logs</a>
      </nav>
    </aside>

    <!-- Main Area -->
    <main class="main-area">
      <!-- Chat Section -->
      <section id="section-chat" class="section active">
        <div class="tabs">
          <button class="tab active" data-tab="chat-tab">Chat</button>
          <button class="tab" data-tab="telegram-tab">Telegram Chats</button>
          <button class="tab" data-tab="voice-tab">Voice</button>
        </div>

        <!-- Chat Tab -->
        <div id="chat-tab" class="tab-content active">
          <div class="chat-list" id="chat-list">
            <div class="chat-list-header">
              <h2>Conversations</h2>
              <button id="new-chat-btn" class="new-chat-btn" title="New conversation">+ New</button>
            </div>
            <div class="chat-list-items">
              <!-- Conversations loaded dynamically -->
            </div>
          </div>
          <div class="chat-view hidden" id="chat-view">
            <div class="chat-view-header">
              <button class="back-btn" id="chat-back">‚Üê Back</button>
            </div>
            <div class="messages-container" id="chat-messages"></div>
            <div class="input-area">
              <form id="chat-form" class="message-form">
                <input type="text" class="message-input" placeholder="Type a message..." required>
                <button type="submit" class="send-btn">Send</button>
              </form>
            </div>
          </div>
        </div>

        <!-- Telegram Tab -->
        <div id="telegram-tab" class="tab-content">
          <div class="telegram-list" id="telegram-list">
            <!-- Conversations loaded dynamically -->
          </div>
          <div class="telegram-chat-view hidden" id="telegram-chat-view">
            <button class="back-btn" id="telegram-back">‚Üê Back to list</button>
            <div class="messages-container" id="telegram-messages"></div>
            <div class="input-area">
              <form id="telegram-form" class="message-form">
                <input type="text" class="message-input" placeholder="Type a message..." required>
                <button type="submit" class="send-btn">Send</button>
              </form>
            </div>
          </div>
        </div>

        <!-- Voice Tab -->
        <div id="voice-tab" class="tab-content">
          <div class="messages-container" id="voice-messages"></div>
          <div class="input-area">
            <form id="voice-form" class="message-form">
              <input type="text" class="message-input" placeholder="Type a message..." required>
              <button type="submit" class="send-btn">Send</button>
            </form>
          </div>
        </div>
      </section>

      <!-- Configuration Section -->
      <section id="section-configuration" class="section">
        <h2>Configuration</h2>
        <form id="config-form" class="config-form">
          <div class="config-section">
            <h3>Web Server</h3>
            <div class="form-group">
              <label for="web-enabled">Enabled</label>
              <input type="checkbox" id="web-enabled" name="web_enabled">
            </div>
            <div class="form-group">
              <label for="web-host">Host</label>
              <input type="text" id="web-host" name="web_host" value="127.0.0.1">
            </div>
            <div class="form-group">
              <label for="web-port">Port</label>
              <input type="number" id="web-port" name="web_port" value="3000">
            </div>
            <div class="form-group">
              <label for="web-auth-token">Auth Token</label>
              <input type="password" id="web-auth-token" name="web_auth_token">
            </div>
          </div>

          <div class="config-section">
            <h3>Agents</h3>
            <div class="form-group">
              <label for="agent-model">Model</label>
              <input type="text" id="agent-model" name="agent_model" value="glm-4.7-flash">
            </div>
            <div class="form-group">
              <label for="agent-temperature">Temperature</label>
              <input type="number" id="agent-temperature" name="agent_temperature" step="0.1" min="0" max="2" value="0.7">
            </div>
            <div class="form-group">
              <label for="agent-max-tokens">Max Tokens</label>
              <input type="number" id="agent-max-tokens" name="agent_max_tokens" value="4096">
            </div>
          </div>

          <div class="config-section">
            <h3>Providers</h3>
            <div class="form-group">
              <label for="provider-zhipu-key">Zhipu API Key</label>
              <input type="password" id="provider-zhipu-key" name="provider_zhipu_key">
            </div>
            <div class="form-group">
              <label for="provider-openai-key">OpenAI API Key</label>
              <input type="password" id="provider-openai-key" name="provider_openai_key">
            </div>
            <div class="form-group">
              <label for="provider-anthropic-key">Anthropic API Key</label>
              <input type="password" id="provider-anthropic-key" name="provider_anthropic_key">
            </div>
          </div>

          <div class="config-section">
            <h3>Channels - Telegram</h3>
            <div class="form-group">
              <label for="telegram-enabled">Enabled</label>
              <input type="checkbox" id="telegram-enabled" name="telegram_enabled">
            </div>
            <div class="form-group">
              <label for="telegram-token">Token</label>
              <input type="password" id="telegram-token" name="telegram_token">
            </div>
            <div class="form-group">
              <label for="telegram-allow-from">Allow From (comma-separated)</label>
              <input type="text" id="telegram-allow-from" name="telegram_allow_from">
            </div>
          </div>

          <div class="config-section">
            <h3>Voice</h3>
            <div class="form-group">
              <label for="voice-wake-word">Wake Word</label>
              <input type="text" id="voice-wake-word" name="voice_wake_word" placeholder="crybot">
            </div>
            <div class="form-group">
              <label for="voice-whisper-path">Whisper Stream Path</label>
              <input type="text" id="voice-whisper-path" name="voice_whisper_stream_path" placeholder="Auto-detect">
            </div>
            <div class="form-group">
              <label for="voice-model-path">Model Path</label>
              <input type="text" id="voice-model-path" name="voice_model_path" placeholder="Auto-detect">
            </div>
            <div class="form-group">
              <label for="voice-language">Language</label>
              <input type="text" id="voice-language" name="voice_language" placeholder="en">
            </div>
            <div class="form-group">
              <label for="voice-threads">Threads</label>
              <input type="number" id="voice-threads" name="voice_threads" value="4" min="1" max="16">
            </div>
            <div class="form-group">
              <label for="voice-piper-model">Piper Model Path</label>
              <input type="text" id="voice-piper-model" name="voice_piper_model" placeholder="Optional">
            </div>
            <div class="form-group">
              <label for="voice-piper-path">Piper Binary Path</label>
              <input type="text" id="voice-piper-path" name="voice_piper_path" placeholder="Auto-detect">
            </div>
            <div class="form-group">
              <label for="voice-timeout">Conversational Timeout (seconds)</label>
              <input type="number" id="voice-timeout" name="voice_conversational_timeout" value="3" min="1" max="30">
            </div>
          </div>

          <div class="config-actions">
            <button type="submit" class="btn-primary">Save Configuration</button>
          </div>
        </form>
      </section>

      <!-- Skills Section -->
      <section id="section-skills" class="section">
        <div class="section-header">
          <h2>Skills</h2>
          <div class="section-actions">
            <button id="add-skill-btn" class="btn-primary">+ Add Skill</button>
            <button id="reload-skills-btn" class="btn-secondary">Reload Skills</button>
          </div>
        </div>

        <!-- Skills List View -->
        <div id="skills-list-view" class="skills-list-view">
          <div class="skills-grid" id="skills-grid">
            <!-- Skills loaded dynamically -->
          </div>
        </div>

        <!-- Skill Editor View -->
        <div id="skill-editor-view" class="skill-editor-view hidden">
          <div class="skill-editor-header">
            <button id="skill-back-btn" class="back-btn">‚Üê Back to Skills</button>
            <h3 id="skill-editor-title">Edit Skill</h3>
          </div>
          <div class="skill-editor-content">
            <div class="skill-editor-tabs">
              <button class="skill-tab active" data-tab="config-tab">Configuration</button>
              <button class="skill-tab" data-tab="docs-tab">Documentation</button>
              <button class="skill-tab" data-tab="credentials-tab">Credentials</button>
            </div>
            <div class="skill-editor-body">
              <div id="config-tab" class="skill-tab-content active">
                <div class="form-group">
                  <label for="skill-dir-name">Skill Directory Name</label>
                  <input type="text" id="skill-dir-name" placeholder="my-skill" readonly>
                  <small>Cannot be changed after creation</small>
                </div>
                <div class="form-group">
                  <label for="skill-config">skill.yml Configuration</label>
                  <textarea id="skill-config" style="display: none;" placeholder="# Enter your skill configuration in YAML format"></textarea>
                  <div id="skill-config-editor" class="code-editor-container"></div>
                  <small>Edit the YAML configuration for your skill.</small>
                </div>
                <div class="skill-actions">
                  <button id="validate-skill-btn" class="btn-secondary">Validate</button>
                  <button id="save-skill-btn" class="btn-primary">Save Skill</button>
                </div>
              </div>
              <div id="docs-tab" class="skill-tab-content">
                <div class="form-group">
                  <label for="skill-docs">SKILL.md Documentation</label>
                  <textarea id="skill-docs" style="display: none;" placeholder="# Skill Name&#10;&#10;Description of what this skill does..."></textarea>
                  <div id="skill-docs-editor" class="code-editor-container"></div>
                  <small>Write documentation for users of this skill.</small>
                </div>
                <div class="skill-actions">
                  <button id="save-docs-btn" class="btn-primary">Save Documentation</button>
                </div>
              </div>
              <div id="credentials-tab" class="skill-tab-content">
                <div id="credentials-container">
                  <!-- Credentials loaded dynamically -->
                </div>
                <div class="credential-note">
                  <strong>How it works:</strong> Credentials are stored in <code>~/.crybot/workspace/skills/your-skill/credentials.yml</code>.
                  They never leave your local system.
                </div>
                <div class="skill-actions">
                  <button id="save-credentials-btn" class="btn-primary">Save Credentials</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Scheduled Tasks Section -->
      <section id="section-scheduled-tasks" class="section">
        <div class="section-header">
          <h2>Scheduled Tasks</h2>
          <div class="section-actions">
            <button id="add-task-btn" class="btn-primary">+ Add Task</button>
            <button id="reload-tasks-btn" class="btn-secondary">Reload</button>
          </div>
        </div>

        <p class="section-description">Configure tasks that run automatically on a schedule.</p>

        <div id="scheduled-tasks-grid" class="tasks-grid">
          <!-- Tasks loaded dynamically -->
        </div>
      </section>

      <!-- MCP Section -->
      <section id="section-mcp" class="section">
        <div class="section-header">
          <h2>MCP Servers</h2>
          <div class="section-actions">
            <button id="add-mcp-server-btn" class="btn-primary">+ Add Server</button>
          </div>
        </div>

        <p class="section-description">Configure Model Context Protocol (MCP) servers to extend Crybot's capabilities with external tools.</p>

        <div class="config-section">
          <h3>Configured Servers</h3>

          <div id="mcp-servers-list" class="mcp-servers-list">
            <!-- MCP servers loaded dynamically -->
            <p class="empty-state">No MCP servers configured.</p>
          </div>
        </div>

        <div class="config-section">
          <h3>About MCP</h3>
          <p>MCP (Model Context Protocol) servers provide external tools and resources to Crybot. Common uses include:</p>
          <ul>
            <li><strong>Browser automation</strong> - Playwright, Puppeteer for web scraping</li>
            <li><strong>Filesystem access</strong> - Read/write files on your system</li>
            <li><strong>Database access</strong> - Query databases directly</li>
            <li><strong>API integrations</strong> - Connect to external services</li>
          </ul>
          <p>Configure servers in your config.yml under the <code>mcp:</code> section, or use this UI.</p>
        </div>
      </section>

      <!-- Logs Section -->
      <section id="section-logs" class="section">
        <h2>Logs</h2>
        <div class="logs-container" id="logs-container">
          <!-- Logs loaded dynamically -->
        </div>
      </section>
    </main>

    <!-- Global Modals (outside sections) -->
    <!-- Scheduled Task Modal -->
    <div id="task-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="task-modal-title">Add Scheduled Task</h3>
          <button class="modal-close" id="close-task-modal-btn">√ó</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="task-name">Task Name</label>
            <input type="text" id="task-name" placeholder="Daily Summary" required>
          </div>
          <div class="form-group">
            <label for="task-description">Description</label>
            <input type="text" id="task-description" placeholder="Generate daily summary">
          </div>
          <div class="form-group">
            <label for="task-prompt">Prompt</label>
            <textarea id="task-prompt" rows="4" placeholder="Generate a summary of today's activities..." required></textarea>
          </div>
          <div class="form-group">
            <label for="task-interval">Schedule</label>
            <input type="text" id="task-interval" placeholder="daily" required>
            <small>Examples: "hourly", "daily", "every 30 minutes", "every 6 hours", "weekly"</small>
          </div>
          <div class="form-group">
            <label>
              <input type="checkbox" id="task-enabled" checked>
              Enabled
            </label>
          </div>
          <div class="form-group">
            <label for="task-forward-channel">Forward Output to Channel (optional)</label>
            <div style="display: flex; gap: 8px; margin-bottom: 8px;">
              <select id="task-forward-channel" style="flex: 1;">
                <option value="">-- No forwarding --</option>
                <option value="telegram">Telegram</option>
                <option value="web">Web Session</option>
                <option value="voice">Voice (TTS)</option>
                <option value="repl">REPL (Console)</option>
              </select>
              <button type="button" id="load-chats-btn" class="btn-secondary btn-sm" disabled>üìã Load Chats</button>
            </div>
            <input type="text" id="task-forward-to" placeholder="Chat ID or Session ID (appears when channel selected)" style="flex: 1;">
            <small>Forward task output to a channel. For Telegram, select chats from the list. For Web, enter a session ID.</small>
            <div id="chats-list" class="telegram-chats-list hidden"></div>
          </div>
          <div class="form-group">
            <label for="task-memory-expiration">Memory Expiration (optional)</label>
            <input type="text" id="task-memory-expiration" placeholder="e.g., 1 hour, 30 minutes, or leave empty for no expiration">
            <small>Clear conversation context before each run. Prevents "I already have the content" responses. Leave empty to keep context between runs.</small>
          </div>
        </div>
        <div class="modal-footer">
          <button id="cancel-task-btn" class="btn-secondary">Cancel</button>
          <button id="save-task-btn" class="btn-primary">Save Task</button>
        </div>
      </div>
    </div>

    <!-- Task Output Modal -->
    <div id="task-output-modal" class="modal hidden">
      <div class="modal-content task-output-modal-content">
        <div class="modal-header">
          <h3 id="task-output-modal-title">Task Output</h3>
          <button class="modal-close" id="close-task-output-modal-btn">√ó</button>
        </div>
        <div class="modal-body">
          <div id="task-output-messages" class="task-output-messages"></div>
          <div class="task-output-input-area">
            <form id="task-output-form" class="task-output-form">
              <input type="text" class="task-output-input" placeholder="Add a message to the task context..." required>
              <button type="submit" class="btn-send">Send</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Create Skill Modal -->
    <div id="create-skill-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Create New Skill</h3>
          <button class="modal-close" id="close-modal-btn">√ó</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="new-skill-name">Skill Directory Name</label>
            <input type="text" id="new-skill-name" placeholder="my-skill" pattern="[a-z0-9_\-]+" required>
            <small>Use lowercase letters, numbers, hyphens, and underscores only.</small>
          </div>
          <div class="form-group">
            <label for="new-skill-template">Start from template</label>
            <select id="new-skill-template">
              <option value="blank">Blank Skill</option>
              <option value="weather">Weather Skill (HTTP API)</option>
              <option value="command">Command Skill</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button id="cancel-create-btn" class="btn-secondary">Cancel</button>
          <button id="create-skill-confirm-btn" class="btn-primary">Create Skill</button>
        </div>
      </div>
    </div>

    <!-- MCP Server Modal -->
    <div id="mcp-server-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="mcp-modal-title">Add MCP Server</h3>
          <button class="modal-close" id="close-mcp-modal-btn">√ó</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label for="mcp-server-name">Server Name</label>
            <input type="text" id="mcp-server-name" placeholder="playwright" required>
            <small>A unique identifier for this server (e.g., "playwright", "filesystem")</small>
          </div>
          <div class="form-group">
            <label for="mcp-connection-type">Connection Type</label>
            <select id="mcp-connection-type">
              <option value="command">Command (stdio)</option>
              <option value="http">HTTP URL</option>
            </select>
            <small>Command connects via stdio, HTTP connects to a URL endpoint</small>
          </div>
          <div class="form-group" id="mcp-command-group">
            <label for="mcp-command">Command</label>
            <input type="text" id="mcp-command" placeholder="npx -y @modelcontextprotocol/server-playwright">
            <small>The command to start the MCP server (space-separated arguments)</small>
          </div>
          <div class="form-group hidden" id="mcp-url-group">
            <label for="mcp-url">HTTP URL</label>
            <input type="text" id="mcp-url" placeholder="http://localhost:3003/mcp">
            <small>The HTTP URL of the MCP server</small>
          </div>
        </div>
        <div class="modal-footer">
          <button id="cancel-mcp-btn" class="btn-secondary">Cancel</button>
          <button id="save-mcp-btn" class="btn-primary">Save Server</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').then(reg => {
        console.log('Service Worker registered');
      }).catch(err => {
        console.log('Service Worker registration failed:', err);
      });
    }
  </script>
</body>
</html>
